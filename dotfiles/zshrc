autoload -U compinit; compinit

[[ -x /opt/homebrew/bin/brew ]] && eval $(/opt/homebrew/bin/brew shellenv)
command -v starship &> /dev/null && eval   "$(starship init zsh)"
command -v kubectl  &> /dev/null && source <(kubectl completion zsh)
command -v spin     &> /dev/null && source <(spin completion)
command -v tunnel   &> /dev/null && source <(tunnel completion zsh)
[[ -f /opt/dev/dev.sh ]] && source /opt/dev/dev.sh
[[ -x /opt/dev/sh/chruby/chruby.sh ]] && type chruby >/dev/null 2>&1 || chruby () { source /opt/dev/sh/chruby/chruby.sh; chruby "$@"; }
[[ -d ~/.kube ]] && for file in ~/.kube/*; do [[ $file = ~/.kube/config* ]] && export KUBECONFIG="${KUBECONFIG}:${file}"; done
[[ -f ~/.zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh ]] && source ~/.zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
[[ -f ~/.zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]] && source ~/.zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

export EDITOR="code -w"

###
## Aliases
###
command -v kubectl    &> /dev/null && alias k=kubectl
command -v kubens     &> /dev/null && alias kn=kubens
command -v kubectx    &> /dev/null && alias kc=kubectx
command -v systemctl  &> /dev/null && alias sc=systemctl
command -v journalctl &> /dev/null && alias jc=journalctl
command -v bat        &> /dev/null && alias cat=bat
command -v batcat     &> /dev/null && alias cat=batcat

if [[ -d ~/.config/spin ]]; then
    command -v kubectl &> /dev/null && alias kprod='kubectl --context "$(cat ~/.config/spin/spin.up.dev/cluster)" -n "$(cat ~/.config/spin/spin.up.dev/namespace)"'
    command -v kubectl &> /dev/null && alias kdev='kubectl --context "$(cat ~/.config/spin/localhost/cluster)" -n "$(cat ~/.config/spin/localhost/namespace)"'
fi

if [[ -d ~/.krew ]]; then
    export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"
fi

###
## SHOPIFY
###
[[ -d ~/src/github.com/Shopify/cloudplatform/workflow-utils ]] && for file in ~/src/github.com/Shopify/cloudplatform/workflow-utils/*.bash; do source ${file}; done

if [ $SPIN ]; then
    export SPIN_HISTFILE="~/.config/spin/config/zsh_history"
    [[ -f /etc/zsh/zshrc.default.inc.zsh ]] && source /etc/zsh/zshrc.default.inc.zsh
fi

[[ -f /opt/dev/sh/chruby/chruby.sh ]] && type chruby >/dev/null 2>&1 || chruby () { source /opt/dev/sh/chruby/chruby.sh; chruby "$@"; }

# cloudplatform: add Shopify clusters to your local kubernetes config
export KUBECONFIG=${KUBECONFIG:+$KUBECONFIG:}/Users/campbel/.kube/config:/Users/campbel/.kube/config.shopify.cloudplatform

###
## Functions
###

reload() {
    source ~/.zshrc
}

gqc() {
    set -ex
    if [[ ! -d .git ]]; then
        echo "Not a git repository."
        return 1
    fi
    MSG=${1:-$(cat /dev/stdin)}
    git add . && git commit -m "$MSG" && git push
    unset -ex
}

gcm() {
    if [[ ! -d .git ]]; then
        echo "Not a git repository."
        return 1
    fi
    CHANGES=$(git diff --ignore-all-space)
    echo "
The following is a diff of the changes you are about to commit.
Please write a commit message that describes the changes you are making.
The commit message should be written in the imperative mood, as if you were
telling someone to do something. For example, \"Fix bug\" and not \"Fixed bug\"
or \"Fixes bug.\" It should also be less than 70 characters long. 
Include just the message, no labels or other text.

Changes:
$CHANGES
" | ezgpt3 -tokens 70
}
